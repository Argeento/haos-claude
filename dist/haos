#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ENV_FILE="${SCRIPT_DIR}/.env"

if [ ! -f "$ENV_FILE" ]; then
  echo "Error: Config not found at $ENV_FILE" >&2
  echo "Make sure you're running haos from the directory where you installed haos-claude." >&2
  echo "Run the installer: curl -sL https://raw.githubusercontent.com/Argeento/haos-claude/main/install.sh | bash" >&2
  exit 1
fi

source "$ENV_FILE"

usage() {
  echo "Usage:" >&2
  echo "  haos start                           Launch Claude with session checks" >&2
  echo "  haos cmd <command>                   Run command on HAOS via SSH" >&2
  echo "  haos put <local> <remote>            Copy file to HAOS via SCP" >&2
  echo "  haos api <METHOD> <ENDPOINT> [BODY] [--jq FILTER | --py SCRIPT]" >&2
  echo "                                       Call HA Core REST API" >&2
  echo "" >&2
  echo "Examples:" >&2
  echo "  haos start" >&2
  echo "  haos cmd ha info" >&2
  echo "  haos cmd cat /config/automations.yaml" >&2
  echo "  haos put /tmp/automations.yaml /config/automations.yaml" >&2
  echo "  haos api GET /api/states" >&2
  echo "  haos api GET /api/states --jq '[.[] | {entity_id, state}]'" >&2
  echo "  haos api GET /api/states --py /tmp/filter.py" >&2
  echo "  haos api POST /api/services/light/turn_on '{\"entity_id\":\"light.example\"}'" >&2
  exit 1
}

[ $# -eq 0 ] && usage

SUBCMD="$1"
shift

case "$SUBCMD" in
  cmd)
    [ $# -eq 0 ] && { echo "Error: haos cmd requires a command" >&2; exit 1; }
    [ -z "${HAOS_SSH_HOST:-}" ] && { echo "Error: HAOS_SSH_HOST not set in $ENV_FILE" >&2; exit 1; }
    ssh -o ConnectTimeout=10 \
        -o BatchMode=yes \
        -p "${HAOS_SSH_PORT:-22}" \
        "$HAOS_SSH_HOST" \
        "$*"
    ;;

  put)
    [ $# -ne 2 ] && { echo "Usage: haos put <local_file> <remote_path>" >&2; exit 1; }
    [ -z "${HAOS_SSH_HOST:-}" ] && { echo "Error: HAOS_SSH_HOST not set in $ENV_FILE" >&2; exit 1; }
    scp -o ConnectTimeout=10 \
        -o BatchMode=yes \
        -P "${HAOS_SSH_PORT:-22}" \
        "$1" "${HAOS_SSH_HOST}:$2"
    ;;

  api)
    [ -z "${HA_URL:-}" ] && { echo "Error: HA_URL not set in $ENV_FILE" >&2; exit 1; }
    if [ -z "${HA_TOKEN:-}" ]; then
      echo "Error: HA_TOKEN not set in $ENV_FILE" >&2
      echo "Create a Long-Lived Access Token in HA UI → Profile → Security → Long-Lived Access Tokens" >&2
      echo "http://homeassistant:8123/profile/security" >&2
      exit 1
    fi

    # Parse positional args and optional --jq / --py flags
    METHOD="" ENDPOINT="" BODY="" JQ_FILTER="" PY_SCRIPT=""
    while [ $# -gt 0 ]; do
      case "$1" in
        --jq) JQ_FILTER="$2"; shift 2 ;;
        --py) PY_SCRIPT="$2"; shift 2 ;;
        *)
          if [ -z "$METHOD" ]; then METHOD="$1"
          elif [ -z "$ENDPOINT" ]; then ENDPOINT="$1"
          else BODY="$1"
          fi
          shift ;;
      esac
    done
    METHOD="${METHOD:-GET}"
    ENDPOINT="${ENDPOINT:-/api/}"

    # Fetch API response
    if [ -n "$BODY" ]; then
      RESPONSE="$(curl -s -X "$METHOD" \
        -H "Authorization: Bearer $HA_TOKEN" \
        -H "Content-Type: application/json" \
        -d "$BODY" \
        "${HA_URL}${ENDPOINT}")"
    else
      RESPONSE="$(curl -s -X "$METHOD" \
        -H "Authorization: Bearer $HA_TOKEN" \
        "${HA_URL}${ENDPOINT}")"
    fi

    # Output: apply --jq, --py, or raw
    if [ -n "$JQ_FILTER" ]; then
      printf '%s' "$RESPONSE" | jq "$JQ_FILTER"
    elif [ -n "$PY_SCRIPT" ]; then
      printf '%s' "$RESPONSE" | PYTHONUTF8=1 python3 "$PY_SCRIPT"
    else
      printf '%s' "$RESPONSE"
    fi
    ;;

  start)
    command -v claude >/dev/null 2>&1 || { echo "Error: Claude Code is not installed" >&2; exit 1; }

    # Version check
    LOCAL_VER="$(cat "${SCRIPT_DIR}/version.txt" 2>/dev/null || echo "")"
    REMOTE_VER="$(curl -fsSL --max-time 5 "https://raw.githubusercontent.com/Argeento/haos-claude/main/dist/version.txt" 2>/dev/null || echo "")"
    if [ -n "$REMOTE_VER" ] && [ -n "$LOCAL_VER" ] && [ "$LOCAL_VER" != "$REMOTE_VER" ]; then
      printf '\n  \033[1;33mUpdate available: v%s → v%s\033[0m\n' "$LOCAL_VER" "$REMOTE_VER"
      printf '  Run to update: curl -sL https://raw.githubusercontent.com/Argeento/haos-claude/main/update.sh | bash\n\n'
    fi

    # SSH check
    printf '  Checking SSH connection... '
    if ssh -o ConnectTimeout=10 -o BatchMode=yes -p "${HAOS_SSH_PORT:-22}" "$HAOS_SSH_HOST" "ha core info" >/dev/null 2>&1; then
      printf '\033[1;32mOK\033[0m\n'
    else
      printf '\033[1;31mFAILED\033[0m\n'
      echo "  Check SSH connectivity and config in $ENV_FILE" >&2
      exit 1
    fi

    # API check
    printf '  Checking API connection... '
    API_RESP="$(curl -s -o /dev/null -w '%{http_code}' --max-time 5 \
      -H "Authorization: Bearer $HA_TOKEN" \
      "${HA_URL}/api/" 2>/dev/null || echo "000")"
    if [ "$API_RESP" = "200" ]; then
      printf '\033[1;32mOK\033[0m\n'
    elif [ "$API_RESP" = "401" ]; then
      printf '\033[1;31mFAILED (401)\033[0m\n'
      echo "  Token is invalid or expired. Generate a new one in HA UI → Profile → Security." >&2
      exit 1
    else
      printf '\033[1;31mFAILED (%s)\033[0m\n' "$API_RESP"
      echo "  Check HA_URL and HA_TOKEN in $ENV_FILE" >&2
      exit 1
    fi

    # Tool checks (non-blocking)
    printf '  Checking jq... '
    if command -v jq >/dev/null 2>&1; then
      printf '\033[1;32mOK\033[0m\n'
    else
      printf '\033[1;33mNOT FOUND\033[0m — install jq for faster JSON processing (./haos api ... --jq)\n'
    fi

    printf '  Checking Python... '
    if command -v python3 >/dev/null 2>&1 || command -v python >/dev/null 2>&1; then
      printf '\033[1;32mOK\033[0m\n'
    else
      printf '\033[1;33mNOT FOUND\033[0m — install Python 3 for JSON processing (./haos api ... --py)\n'
    fi

    printf '\n'
    export PYTHONUTF8=1
    unset CLAUDECODE
    claude "Display the session start disclaimer as defined in CLAUDE.md"
    ;;

  *)
    echo "Error: Unknown subcommand '$SUBCMD'" >&2
    usage
    ;;
esac
